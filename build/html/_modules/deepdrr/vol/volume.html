<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>deepdrr.vol.volume &mdash; DeepDRR 1.1.0a3 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=9d604193"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DeepDRR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../deepdrr.html">deepdrr package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DeepDRR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">deepdrr.vol.volume</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for deepdrr.vol.volume</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Volume class for CT volume.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">pydicom.filereader</span> <span class="kn">import</span> <span class="n">dcmread</span>
<span class="kn">import</span> <span class="nn">nrrd</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RegularGridInterpolator</span>
<span class="kn">import</span> <span class="nn">pyvista</span> <span class="k">as</span> <span class="nn">pv</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">load_dicom</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">geo</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">data_utils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">mesh_utils</span>
<span class="kn">from</span> <span class="nn">..device</span> <span class="kn">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">..projector.material_coefficients</span> <span class="kn">import</span> <span class="n">material_coefficients</span>

<span class="n">vtk</span><span class="p">,</span> <span class="n">nps</span><span class="p">,</span> <span class="n">vtk_available</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">try_import_vtk</span><span class="p">()</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Volume"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume">[docs]</a><span class="k">class</span> <span class="nc">Volume</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">materials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="n">anatomical_from_IJK</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span>
    <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span>
    <span class="n">anatomical_coordinate_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO: The current Volume class is really a scanned volume. We should have a BaseVolume or</span>
    <span class="c1"># GenericVolume, which might be subclassed by tools or other types of volumes not constructed</span>
    <span class="c1"># from array data, e.g. for which materials is perfectly known.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">materials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">anatomical_from_IJK</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">anatomical_coordinate_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">anatomical_from_ijk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A deepdrr Volume object with materials segmentation and orientation in world-space.</span>

<span class="sd">        The recommended way to create a Volume is to load from a file using the classmethods</span>
<span class="sd">        `from_nifti()` or `from_nrrd()`.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (np.ndarray): The density data (a 3D array).</span>
<span class="sd">            materials (Dict[str, np.ndarray]): material segmentation of the volume, mapping material name to binary segmentation.</span>
<span class="sd">            anatomical_from_IJK (geo.FrameTransform): transformation from IJK space to anatomical (RAS or LPS).</span>
<span class="sd">            world_from_anatomical (Optional[geo.FrameTransform], optional): transformation from the anatomical space to world coordinates. If None, assumes identity. Defaults to None.</span>
<span class="sd">            anatomical_coordinate_system (str, optional): String denoting the coordinate system. Either &quot;LPS&quot;, &quot;RAS&quot;, or None.</span>
<span class="sd">                This may be useful for ensuring compatibility with other data, but it is not checked or used internally (yet). Defaults to None.</span>
<span class="sd">            cache_dir ()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">materials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_materials</span><span class="p">(</span><span class="n">materials</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anatomical_from_ijk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Deprecation warning</span>
            <span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">anatomical_from_ijk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">frame_transform</span><span class="p">(</span><span class="n">anatomical_from_IJK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">world_from_anatomical</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">geo</span><span class="o">.</span><span class="n">frame_transform</span><span class="p">(</span><span class="n">world_from_anatomical</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">=</span> <span class="n">anatomical_coordinate_system</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LPS&quot;</span><span class="p">,</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

<div class="viewcode-block" id="Volume.get_config"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.get_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the configuration of the volume. Does not include volumetric data.</span>

<span class="sd">        Includes any info passed into `config`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: The configuration of the volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">anatomical_from_IJK</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div>

<div class="viewcode-block" id="Volume.from_parameters"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.from_parameters">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parameters</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">materials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">anatomical_coordinate_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a volume object with a segmentation of the materials, from parameters.</span>

<span class="sd">        Note that the anatomical coordinate system is not the world coordinate system (which is cartesian).</span>

<span class="sd">        Suggested anatomical coordinate space units is millimeters.</span>
<span class="sd">        A helpful introduction to the geometry is can be found [here](https://www.slicer.org/wiki/Coordinate_systems).</span>

<span class="sd">        Args:</span>
<span class="sd">            volume (np.ndarray): the volume density data.</span>
<span class="sd">            materials (Dict[str, np.ndarray]): mapping from material names to binary segmentation of that material.</span>
<span class="sd">            origin (Point3D): Location of the volume&#39;s origin in the anatomical coordinate system.</span>
<span class="sd">            spacing (Tuple[float, float, float], optional): Spacing of the volume in the anatomical coordinate system. Defaults to (1, 1, 1).</span>
<span class="sd">            anatomical_coordinate_system (Optional[str]): anatomical coordinate system convention, either &quot;RAS&quot; or &quot;LPS&quot;. Defaults to None.</span>
<span class="sd">            world_from_anatomical (FrameTransform, optional): Optional transformation from anatomical to world coordinates.</span>
<span class="sd">                If None, then identity is used. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">spacing</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="c1"># define anatomical_from_ijk FrameTransform</span>
        <span class="k">if</span> <span class="n">anatomical_coordinate_system</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_scaling</span><span class="p">(</span>
                <span class="n">scaling</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">origin</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;LPS&quot;</span><span class="p">:</span>
            <span class="c1"># IJKtoLPS = LPS_from_IJK</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">]</span>
            <span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rt</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;conversion from RAS (not hard, look at LPS example)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="n">materials</span><span class="p">,</span>
            <span class="n">anatomical_from_ijk</span><span class="o">=</span><span class="n">anatomical_from_IJK</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="n">anatomical_coordinate_system</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Volume.from_hu"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.from_hu">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hu</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">anatomical_coordinate_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_hounsfield_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_segment_materials</span><span class="p">(</span><span class="n">hu_values</span><span class="p">,</span> <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_parameters</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">materials</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="n">anatomical_coordinate_system</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_cache_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the cache dir used for surfaces or other things.</span>

<span class="sd">        Args:</span>
<span class="sd">            cache_dir (Optional[Path], optional): If provided separately by the user. Saved if current cache_dir is None. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Path]: The cache_dir, if it can be found. Created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_dir</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_cache_path_root</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">cache_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the cache path.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="n">cache_name</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_hounsfield_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">smooth_air</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Use two linear interpolations from data: (HU,g/cm^3)</span>
        <span class="c1"># use for lower HU: density = 0.001029*HU + 1.03</span>
        <span class="c1"># use for upper HU: density = 0.0005886*HU + 1.03</span>

        <span class="c1"># set air densities</span>
        <span class="k">if</span> <span class="n">smooth_air</span><span class="p">:</span>
            <span class="n">hu_values</span><span class="p">[</span><span class="n">hu_values</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">900</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
        <span class="c1"># hu_values[hu_values &gt; 600] = 5000;</span>
        <span class="n">densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">0.001029</span> <span class="o">*</span> <span class="n">hu_values</span> <span class="o">+</span> <span class="mf">1.030</span><span class="p">,</span> <span class="mf">0.0005886</span> <span class="o">*</span> <span class="n">hu_values</span> <span class="o">+</span> <span class="mf">1.03</span><span class="p">),</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">densities</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_segment_materials</span><span class="p">(</span>
        <span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Segment the materials.</span>

<span class="sd">        Meant for internal use, particularly to be overriden by volumes with different materials.</span>

<span class="sd">        Args:</span>
<span class="sd">            hu_values (np.ndarray): volume data in Hounsfield Units.</span>
<span class="sd">            use_thretholding (bool, optional): whether to segment with thresholding (true) or a DNN. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, np.ndarray]: materials segmentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_thresholding</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">load_dicom</span><span class="o">.</span><span class="n">conv_hu_to_materials_thresholding</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">load_dicom</span><span class="o">.</span><span class="n">conv_hu_to_materials</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>

<div class="viewcode-block" id="Volume.segment_materials"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.segment_materials">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">segment_materials</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">anatomical_from_ijk</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Segment the materials in a volume, potentially caching.</span>

<span class="sd">        If cache_dir is None, then</span>

<span class="sd">        Args:</span>
<span class="sd">            hu_values (np.ndarray): volume data in Hounsfield Units.</span>
<span class="sd">            use_thretholding (bool, optional): whether to segment with thresholding (true) or a DNN. Defaults to True.</span>
<span class="sd">            use_cached (bool, optional): use the cached segmentation, if it exists. Defaults to True.</span>
<span class="sd">            save_cache (bool, optional): save the segmentation to cache_dir. Defaults to True.</span>
<span class="sd">            cache_dir (Optional[Path], optional): where to look for the segmentation cache. If None, no caching performed. Defaults to None.</span>
<span class="sd">            cache_name (str, optional): Name of cache file. Must be provided if use_cached or cache_dir is True. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, np.ndarray]: materials segmentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_root</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_cache_path_root</span><span class="p">(</span>
            <span class="n">cache_name</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache path root: </span><span class="si">{</span><span class="n">path_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;segmenting materials in volume&quot;</span><span class="p">)</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_segment_materials</span><span class="p">(</span><span class="n">hu_values</span><span class="p">,</span> <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">materials</span>

        <span class="n">materials_path_npz</span> <span class="o">=</span> <span class="n">path_root</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
        <span class="n">materials_record_path</span> <span class="o">=</span> <span class="n">path_root</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="n">materials_path_nifti</span> <span class="o">=</span> <span class="n">path_root</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_cached</span> <span class="ow">and</span> <span class="n">materials_path_npz</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using cached materials segmentation at </span><span class="si">{</span><span class="n">materials_path_npz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">materials_path_npz</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">use_cached</span> <span class="ow">and</span> <span class="n">materials_record_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">materials_path_nifti</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using cached materials segmentation at </span><span class="si">{</span><span class="n">materials_path_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">material_names</span> <span class="o">=</span> <span class="n">data_utils</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">materials_record_path</span><span class="p">)</span>
            <span class="n">materal_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">materials_path_nifti</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">material_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">materials</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">materal_data</span> <span class="o">==</span> <span class="n">label</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;segmenting materials in volume&quot;</span><span class="p">)</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_segment_materials</span><span class="p">(</span><span class="n">hu_values</span><span class="p">,</span> <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">materials_path_nifti</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving materials segmentation to </span><span class="si">{</span><span class="n">materials_path_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">material_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">materials</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">material_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hu_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">material_names</span><span class="p">:</span>
                    <span class="n">material_data</span><span class="p">[</span><span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span> <span class="o">=</span> <span class="n">material_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">material_data</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">anatomical_from_ijk</span><span class="p">))</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">materials_path_nifti</span><span class="p">)</span>
                <span class="n">data_utils</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">materials_record_path</span><span class="p">,</span> <span class="n">material_names</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">materials</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anatomical_from_ijk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>

    <span class="nd">@anatomical_from_ijk</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">anatomical_from_ijk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">LPS_from_IJK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the LPS_from_IJK transform.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;LPS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">geo</span><span class="o">.</span><span class="n">LPS_from_RAS</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown anatomical coordinate system </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">IJK_from_LPS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LPS_from_IJK</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">RAS_from_IJK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the RAS_from_IJK transform.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;LPS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">geo</span><span class="o">.</span><span class="n">RAS_from_LPS</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown anatomical coordinate system </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">IJK_from_RAS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RAS_from_IJK</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>

<div class="viewcode-block" id="Volume.save"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the volume to disk as a nifti file.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (Path): a directory to save the volume and segmentations to.</span>
<span class="sd">            segmentation (bool, optional): if the volume is a segmentation, there&#39;s</span>
<span class="sd">                no need to save the materials.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># save the volume</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RAS_from_IJK</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;data.nii.gz&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;world_from_anatomical.txt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">segmentation</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Save the material segmentations</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">segmentation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RAS_from_IJK</span><span class="p">))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Volume.load"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Volume</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Volume</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a volume from disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (Path): a directory containing the volume and segmentations.</span>
<span class="sd">            segmentation (bool, optional): if the volume is a segmentation,</span>
<span class="sd">                populate the materials from that.</span>

<span class="sd">        Returns: Volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="c1"># load the volume</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;data.nii.gz&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">segmentation</span><span class="p">:</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bone</span><span class="o">=</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># load the segmentations</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nii.gz&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;data.nii.gz&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">materials</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">materials</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No materials found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">. Did you mean to load a segmentation?&quot;</span>
                <span class="p">)</span>

        <span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;world_from_anatomical.txt&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="n">materials</span><span class="p">,</span>
            <span class="n">anatomical_from_IJK</span><span class="o">=</span><span class="n">geo</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">),</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Volume.from_nifti"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.from_nifti">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_nifti</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">materials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">segmentation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">density_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a volume from NiFti file.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (Path): path to the .nii.gz file.</span>
<span class="sd">            use_thresholding (bool, optional): segment the materials using thresholding (faster but less accurate). Defaults to True.</span>
<span class="sd">            world_from_anatomical (Optional[geo.FrameTransform], optional): position the volume in world space. If None, uses identity. Defaults to None.</span>
<span class="sd">            use_cached (bool, optional): Use a cached segmentation if available. Defaults to True.</span>
<span class="sd">            cache_dir (Optional[Path], optional): Where to load/save the cached segmentation. If None, use a &quot;cache&quot; directory</span>
<span class="sd">                in the same location as the nifti file. Defaults to None.</span>
<span class="sd">            materials: Optional material segmentation, as a dictionary mapping material name to binary segmentation.</span>
<span class="sd">                If not provided, materials are segmented from the CT. Defaults to None.</span>
<span class="sd">                Can also provide a dictionary mapping material names to Nifti files containing the segmentations.</span>
<span class="sd">            segmentation (bool, optional) If the file is a segmentation file, then its &quot;materials&quot; correspond to a high density material (bone),</span>
<span class="sd">                where the values are &gt;0. Defaults to false. Overrides provided materials.</span>
<span class="sd">            label: which labels to treat as solid. If None, then all nonzero labels are treated as solid. Defaults to None.</span>
<span class="sd">            density_kwargs: Additional kwargs passed to convert_hounsfield_to_density.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Volume: A new volume object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">,</span>
            <span class="n">use_cached</span><span class="o">=</span><span class="n">use_cached</span><span class="p">,</span>
            <span class="n">save_cache</span><span class="o">=</span><span class="n">save_cache</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">segmentation</span><span class="o">=</span><span class="n">segmentation</span><span class="p">,</span>
            <span class="n">density_kwargs</span><span class="o">=</span><span class="n">density_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cache&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading NiFti volume from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_xyzt_units</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got NifTi xyz units: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_xyzt_units</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">. (Expected &quot;mm&quot;).&#39;</span><span class="p">)</span>

        <span class="n">anatomical_from_IJK</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">segmentation</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">seg</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">seg</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">label</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid label: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bone</span><span class="o">=</span><span class="n">seg</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hu_values</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_hounsfield_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">,</span> <span class="o">**</span><span class="n">density_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">materials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">materials</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">segment_materials</span><span class="p">(</span>
                    <span class="n">hu_values</span><span class="p">,</span>
                    <span class="n">anatomical_from_IJK</span><span class="p">,</span>
                    <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">,</span>
                    <span class="n">use_cached</span><span class="o">=</span><span class="n">use_cached</span><span class="p">,</span>
                    <span class="n">save_cache</span><span class="o">=</span><span class="n">save_cache</span><span class="p">,</span>
                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
                    <span class="n">cache_name</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if the materials provided are path names.</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find material </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">materials</span><span class="p">,</span>
            <span class="n">anatomical_from_IJK</span><span class="o">=</span><span class="n">anatomical_from_IJK</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Volume.from_dicom"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.from_dicom">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dicom</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load a volume from a dicom file and compute the anatomical_from_ijk transform from metadata</span>
<span class="sd">        https://www.slicer.org/wiki/Coordinate_systems</span>
<span class="sd">        Args:</span>
<span class="sd">            path: path-like to a multi-frame dicom file. (Currently only Multi-Frame from Siemens supported)</span>
<span class="sd">            use_thresholding (bool, optional): segment the materials using thresholding (faster but less accurate). Defaults to True.</span>
<span class="sd">            world_from_anatomical (Optional[geo.FrameTransform], optional): position the volume in world space. If None, uses identity. Defaults to None.</span>
<span class="sd">            use_cached (bool, optional): [description]. Use a cached segmentation if available. Defaults to True.</span>
<span class="sd">            cache_dir (Optional[Path], optional): Where to load/save the cached segmentation. If None, use the parent dir of `path`. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Volume: an instance of a deepdrr volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">//</span> <span class="s2">&quot;cache&quot;</span>

        <span class="c1"># Multi-frame dicoms store all slices of a volume in one file.</span>
        <span class="c1"># they must specify the necessary dicom tags under</span>
        <span class="c1"># https://dicom.innolitics.com/ciods/enhanced-ct-image/enhanced-ct-image-multi-frame-functional-groups</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Currently only multi-frame dicoms are supported. Path must refer to a file.&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading Dicom volume from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># reading the dicom dataset object</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># slice specific tags</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">PerFrameFunctionalGroupsSequence</span>
        <span class="n">num_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="n">first_slice_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PlanePositionSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImagePositionPatient</span><span class="p">)</span>
        <span class="n">last_slice_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PlanePositionSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImagePositionPatient</span><span class="p">)</span>

        <span class="c1"># volume specific tags</span>
        <span class="n">shared</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">SharedFunctionalGroupsSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">RC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">PlaneOrientationSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ImageOrientationPatient</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">PixelSpacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">)</span>
        <span class="n">SliceThickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">PixelMeasuresSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SliceThickness</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">PixelValueTransformationSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RescaleIntercept</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">PixelValueTransformationSequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RescaleSlope</span>

        <span class="c1"># make user aware that this is only tested on windows</span>
        <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">Manufacturer</span> <span class="o">!=</span> <span class="s2">&quot;SIEMENS&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Multi-frame loading has only been tested on Siemens Enhanced CT DICOMs.&quot;</span>
                <span class="s2">&quot;Please verify everything works as expected.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># read the &#39;raw&#39; data array</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pixel_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">hu_values</span> <span class="o">=</span> <span class="n">raw_data</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">offset</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EXPLANATION - indexing conventions</span>

<span class="sd">        According to dicom (C.7.6.3.1.4 - Pixel Data) slices are of shape (Rows, Columns) </span>
<span class="sd">        =&gt; must be (j, i) indexed if we define i == horizontal and j == vertical.</span>
<span class="sd">        =&gt; we want to conform to the (i, j, k) layout and therefore move the axis of the data array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># convert data to our indexing convention (k, j, i) -&gt; (j, i, k)</span>
        <span class="n">hu_values</span> <span class="o">=</span> <span class="n">hu_values</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># transform the volume in HU to densities</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_dicom</span><span class="o">.</span><span class="n">conv_hu_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>

        <span class="c1"># obtain materials analogous to nifti</span>
        <span class="k">if</span> <span class="n">use_thresholding</span><span class="p">:</span>
            <span class="n">materials_path</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stem</span><span class="si">}</span><span class="s2">_materials_thresholding.npz&quot;</span>
            <span class="k">if</span> <span class="n">use_cached</span> <span class="ow">and</span> <span class="n">materials_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found materials segmentation at </span><span class="si">{</span><span class="n">materials_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="c1"># TODO: recover from EOFError</span>
                <span class="n">materials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">materials_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;segmenting materials in volume&quot;</span><span class="p">)</span>
                <span class="n">materials</span> <span class="o">=</span> <span class="n">load_dicom</span><span class="o">.</span><span class="n">conv_hu_to_materials_thresholding</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">materials_path</span><span class="p">,</span> <span class="o">**</span><span class="n">materials</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">materials_path</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stem</span><span class="si">}</span><span class="s2">_materials.npz&quot;</span>
            <span class="k">if</span> <span class="n">use_cached</span> <span class="ow">and</span> <span class="n">materials_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found materials segmentation at </span><span class="si">{</span><span class="n">materials_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">materials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">materials_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;segmenting materials in volume&quot;</span><span class="p">)</span>
                <span class="n">materials</span> <span class="o">=</span> <span class="n">load_dicom</span><span class="o">.</span><span class="n">conv_hu_to_materials</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">materials_path</span><span class="p">,</span> <span class="o">**</span><span class="n">materials</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EXPLANATION - 3d affine transform</span>
<span class="sd">        </span>
<span class="sd">        DICOM does not offer a 3d transform to locate the voxel data in world space for historic reasons.</span>
<span class="sd">        However we can construct it from some related DICOM tags. See this resource for more information:</span>
<span class="sd">        https://nipy.org/nibabel/dicom/dicom_orientation.html</span>
<span class="sd">        </span>
<span class="sd">        Note, that we do not modify the affine transform to account for the differences in indexing, but </span>
<span class="sd">        instead modified the data in memory to be in (i, j, k) order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># construct column for index k</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">last_slice_position</span> <span class="o">-</span> <span class="n">first_slice_position</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_slices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># check if the calculated increment matches the SliceThickness (allow .1 millimeters deviations)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">SliceThickness</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># apply scaling to mm</span>
        <span class="n">RC_scaled</span> <span class="o">=</span> <span class="n">RC</span> <span class="o">*</span> <span class="n">PixelSpacing</span>

        <span class="c1"># construct rotation matrix from three columns for (i, j, k)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">RC_scaled</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

        <span class="c1"># construct affine matrix</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot</span>  <span class="c1"># rotation and scaling</span>
        <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_slice_position</span>  <span class="c1"># translation</span>
        <span class="n">affine</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># homogenous component</span>

        <span class="c1"># log affine matrix in debug mode</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;manually constructed affine matrix: </span><span class="se">\n</span><span class="si">{</span><span class="n">affine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;volume_center_xyz : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">affine</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">affine</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># cast to FrameTransform</span>
        <span class="n">lps_from_ijk</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>

        <span class="c1"># constructing the volume</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">materials</span><span class="p">,</span> <span class="n">lps_from_ijk</span><span class="p">,</span> <span class="n">world_from_anatomical</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Volume.from_nrrd"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.from_nrrd">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_nrrd</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">world_from_anatomical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a volume from a nrrd file.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): path to the file.</span>
<span class="sd">            use_thresholding (bool, optional): segment the materials using thresholding (faster but less accurate). Defaults to True.</span>
<span class="sd">            world_from_anatomical (Optional[geo.FrameTransform], optional): position the volume in world space. If None, uses identity. Defaults to None.</span>
<span class="sd">            use_cached (bool, optional): Use a cached segmentation if available. Defaults to True.</span>
<span class="sd">            cache_dir (Optional[Path], optional): Where to load/save the cached segmentation. If None, use the parent dir of `path`. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Volume: A volume formed from the NRRD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">hu_values</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">ijk_from_anatomical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;space directions&quot;</span><span class="p">],</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;space origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TODO: double check this transform.&quot;</span><span class="p">)</span>
        <span class="n">anatomical_from_ijk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ijk_from_anatomical</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_hounsfield_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">)</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">segment_materials</span><span class="p">(</span>
            <span class="n">hu_values</span><span class="p">,</span>
            <span class="n">anatomical_from_ijk</span><span class="o">=</span><span class="n">anatomical_from_ijk</span><span class="p">,</span>
            <span class="n">use_thresholding</span><span class="o">=</span><span class="n">use_thresholding</span><span class="p">,</span>
            <span class="n">use_cached</span><span class="o">=</span><span class="n">use_cached</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">cache_name</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">anatomical_coordinate_system</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;right-anterior-superior&quot;</span><span class="p">:</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;left-posterior-superior&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS&quot;</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;space&quot;</span><span class="p">,</span> <span class="s2">&quot;right-anterior-superior&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">materials</span><span class="p">,</span>
            <span class="n">anatomical_from_ijk</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="n">anatomical_coordinate_system</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">world_from_IJK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">world_from_ijk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_IJK</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">IJK_from_world</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_IJK</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ijk_from_world</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_IJK</span><span class="o">.</span><span class="n">inv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anatomical_from_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">inv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ijk_from_anatomical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span><span class="o">.</span><span class="n">inv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">IJK_from_anatomical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_IJK</span><span class="o">.</span><span class="n">inv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin of the volume in anatomical space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="n">origin_in_anatomical</span> <span class="o">=</span> <span class="n">origin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin_in_world</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin of the volume in world space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_ijk</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center_in_world</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The center of the volume in world coorindates. Useful for debugging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_ijk</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Volume.get_bounding_box_in_world"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.get_bounding_box_in_world">[docs]</a>    <span class="k">def</span> <span class="nf">get_bounding_box_in_world</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the corners of a bounding box enclosing the volume in world coordinates.</span>

<span class="sd">        Assumes cell-centered sampling.</span>

<span class="sd">        Returns:</span>
<span class="sd">            geo.Point3D: The lower corner of the bounding box.</span>
<span class="sd">            geo.Point3D: The upper corner of the bounding box.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">corners_ijk</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_ijk</span> <span class="o">@</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">corners_ijk</span><span class="p">])</span>
        <span class="n">min_corner</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">corners</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">max_corner</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">corners</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">min_corner</span><span class="p">,</span> <span class="n">max_corner</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">geo</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The spacing of the voxels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">geo</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="o">.</span><span class="n">R</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_format_materials</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">materials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standardize the input material segmentation.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">:</span>
            <span class="n">materials</span><span class="p">[</span><span class="n">mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="n">mat</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">materials</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

<div class="viewcode-block" id="Volume.place_center"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.place_center">[docs]</a>    <span class="k">def</span> <span class="nf">place_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the volume so that its center is located at world-space point x.</span>

<span class="sd">        Only changes the translation elements of the world_from_anatomical transform. Preserves the current rotation of the</span>

<span class="sd">        Args:</span>
<span class="sd">            x (geo.Point3D): the world-space point.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">center_anatomical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">center_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">@</span> <span class="n">center_anatomical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">center_anatomical</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>

    <span class="n">translate_center_to</span> <span class="o">=</span> <span class="n">place_center</span>

<div class="viewcode-block" id="Volume.place"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_in_anatomical</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">,</span> <span class="n">desired_point_in_world</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the volume so that x_in_anatomical corresponds to x_in_world.&quot;&quot;&quot;</span>
        <span class="n">p_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_in_anatomical</span><span class="p">)</span>
        <span class="n">p_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">desired_point_in_world</span><span class="p">)</span>
        <span class="n">r_WA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">R</span>
        <span class="n">t_WA</span> <span class="o">=</span> <span class="n">p_W</span> <span class="o">-</span> <span class="n">r_WA</span> <span class="o">@</span> <span class="n">p_A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t_WA</span>  <span class="c1"># fancy setter</span></div>

<div class="viewcode-block" id="Volume.copy_pose"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.copy_pose">[docs]</a>    <span class="k">def</span> <span class="nf">copy_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy the pose of another volume.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Volume.translate"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Volume</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the volume by `t`.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (geo.Vector3D): The vector to translate by, in world space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_translation</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Volume.rotate"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">,</span> <span class="n">Rotation</span><span class="p">],</span>
        <span class="n">center</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Volume</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotate the volume by `rotation` about `center`.</span>

<span class="sd">        Args:</span>
<span class="sd">            rotation (Union[geo.Vector3D, Rotation]): the rotation in world-space. If it is a vector, `Rotation.from_rotvec(rotation)` is used.</span>
<span class="sd">            center (geo.Point3D, optional): the center of rotation in world space coordinates. If None, the center of the volume is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="n">Rotation</span><span class="p">):</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rotation</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rotation</span><span class="p">(</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_in_world</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_translation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">R</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Volume.supine"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.supine">[docs]</a>    <span class="k">def</span> <span class="nf">supine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Turns the volume to be face up.</span>

<span class="sd">        This aligns the patient so that, in world space,</span>
<span class="sd">        the anterior side is toward +Z, inferior is toward +X,</span>
<span class="sd">        and left is toward +Y.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the anatomical coordinate system is not &quot;RAS&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rt</span><span class="p">(</span>
                <span class="n">rotation</span><span class="o">=</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s2">&quot;xz&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">],</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="n">faceup</span> <span class="o">=</span> <span class="n">supine</span>

<div class="viewcode-block" id="Volume.prone"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.prone">[docs]</a>    <span class="k">def</span> <span class="nf">prone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Turns the volume to be face down.</span>

<span class="sd">        This aligns the patient so that, in world space,</span>
<span class="sd">        the posterior side is toward +Z, inferior is toward +X,</span>
<span class="sd">        and right is toward +Y.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the anatomical coordinate system is not &quot;RAS&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rt</span><span class="p">(</span>
                <span class="n">rotation</span><span class="o">=</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s2">&quot;xz&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="n">facedown</span> <span class="o">=</span> <span class="n">prone</span>

<div class="viewcode-block" id="Volume.orient_patient"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.orient_patient">[docs]</a>    <span class="k">def</span> <span class="nf">orient_patient</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">head_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">supine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">world_from_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Orient the patient with the given orientation, aligning with the Loop-X coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            head_first: If True, the patient is oriented with head (superior axis) pointing in the -Y direction. Defaults to True.</span>
<span class="sd">            supine: If True, the patient is oriented so that the anterior axis (stomach) points toward +Z. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># R for the RAS_from_world</span>
        <span class="k">if</span> <span class="n">head_first</span> <span class="ow">and</span> <span class="n">supine</span><span class="p">:</span>
            <span class="c1"># R &lt;- x, A &lt;- z, S &lt;- -y</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">head_first</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">supine</span><span class="p">:</span>
            <span class="c1"># R &lt;- -x, A &lt;- -z, S &lt;- -y</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">head_first</span> <span class="ow">and</span> <span class="n">supine</span><span class="p">:</span>
            <span class="c1"># R &lt;- -x, A &lt;- z, S &lt;- y</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">head_first</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">supine</span><span class="p">:</span>
            <span class="c1"># R &lt;- x, A &lt;- -z, S &lt;- y</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid patient orientation.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">world_from_device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Invert the rotation to go from RAS to world, keep the same translation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rt</span><span class="p">(</span>
                <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">t</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">device_from_anatomical</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">FrameTransform</span><span class="o">.</span><span class="n">from_rt</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span> <span class="o">=</span> <span class="n">world_from_device</span> <span class="o">@</span> <span class="n">device_from_anatomical</span></div>

<div class="viewcode-block" id="Volume.interpolate"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate the value of the volume at the point.</span>

<span class="sd">        This is a *slow* version of interpolation, using scipy under the hood. DeepDRR uses cubic</span>
<span class="sd">        spline interpolation on the GPU for rendering. This function is provided as a convenience.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (geo.Point3D): The point or points in world-space.</span>
<span class="sd">            method (str): The interpolation method to be used.</span>
<span class="sd">                Accepted values are &quot;linear&quot; and &quot;nearest&quot;.</span>
<span class="sd">                Defaults to &quot;linear.&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[float, np.ndarray]: The interpolated value(s) of the point(s)</span>
<span class="sd">                in the Volume. If a point is outside the volume, the value is NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_interpolator&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ijk_from_world</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether the point x is inside the volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (geo.Point3D)world&#39;: [-1346.4464, -65.99151, 8.187973], &#39;fractured&#39;: False,</span>
<span class="sd">                             &#39;cortical_breach&#39;: &#39;TODO&#39;}: world-space point.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_ijk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ijk_from_world</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_ijk</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Volume.isosurface"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.isosurface">[docs]</a>    <span class="k">def</span> <span class="nf">isosurface</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">node_centered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">smooth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">decimation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">decimation_points</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">smooth_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">relaxation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">convert_to_LPS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an isosurface from the volume&#39;s data, transforming to anatomical_coordinates.</span>

<span class="sd">        Accepts arguments passed to :func:`deepdrr.utils.mesh_utils.isosurface`.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (float): The value at which to make the isosurface.</span>
<span class="sd">            label (int): The label of the isosurface.</span>
<span class="sd">            node_centered (bool): If True, the isosurface is centered at the node.</span>
<span class="sd">                If False, the isosurface is centered at the cell.</span>
<span class="sd">            smooth (bool): If True, the isosurface is smoothed.</span>
<span class="sd">            decimation (float): The decimation factor (how many points to remove).</span>
<span class="sd">            smooth_iter (int): The number of smoothing iterations.</span>
<span class="sd">            relaxation_factor (float): The relaxation factor.</span>
<span class="sd">            convert_to_LPS (bool): If True, the isosurface is converted to LPS coordinates. (Recommended)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pv.PolyData: The surface mesh in anatomical coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pad data with 0s to avoid open surfaces at the edges.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">surface</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">isosurface</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">node_centered</span><span class="o">=</span><span class="n">node_centered</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">decimation</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
            <span class="n">smooth_iter</span><span class="o">=</span><span class="n">smooth_iter</span><span class="p">,</span>
            <span class="n">relaxation_factor</span><span class="o">=</span><span class="n">relaxation_factor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Subtract 1 in all directions to remove pad</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert to anatomical coordinates</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span> <span class="o">==</span> <span class="s2">&quot;RAS&quot;</span> <span class="ow">and</span> <span class="n">convert_to_LPS</span><span class="p">:</span>
            <span class="c1"># Convert to LPS</span>
            <span class="n">surface</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">RAS_from_LPS</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">decimation_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">surface</span><span class="o">.</span><span class="n">n_points</span> <span class="o">&gt;</span> <span class="n">decimation_points</span><span class="p">:</span>
            <span class="c1"># Decimate the surface to the desired number of points</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">decimation_points</span> <span class="o">/</span> <span class="n">surface</span><span class="o">.</span><span class="n">n_points</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">surface</span></div>

    <span class="k">def</span> <span class="nf">_make_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bone&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a surface for the boolean segmentation&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">material</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s1">&quot; not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">segmentation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="p">[</span><span class="n">material</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="o">.</span><span class="n">R</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="o">.</span><span class="n">t</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStructuredPoints</span><span class="p">()</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">SetDimensions</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">SetOrigin</span><span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># negate?</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># negate?</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">SetSpacing</span><span class="p">(</span>
            <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>  <span class="c1"># negate?</span>
        <span class="p">)</span>

        <span class="n">segmentation</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">scalars</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">scalars</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;isolating bone surface for visualization...&quot;</span><span class="p">)</span>
        <span class="n">dmc</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDiscreteMarchingCubes</span><span class="p">()</span>
        <span class="n">dmc</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
        <span class="n">dmc</span><span class="o">.</span><span class="n">GenerateValues</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dmc</span><span class="o">.</span><span class="n">ComputeGradientsOff</span><span class="p">()</span>
        <span class="n">dmc</span><span class="o">.</span><span class="n">ComputeNormalsOff</span><span class="p">()</span>
        <span class="n">dmc</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">surface</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">dmc</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">surface</span><span class="o">.</span><span class="n">is_all_triangles</span><span class="p">:</span>
            <span class="n">surface</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">surface</span><span class="o">.</span><span class="n">decimate_pro</span><span class="p">(</span>
            <span class="mf">0.01</span><span class="p">,</span>
            <span class="n">feature_angle</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">splitting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span>
            <span class="n">n_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">relaxation_factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="n">feature_angle</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
            <span class="n">boundary_smoothing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">compute_normals</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">surface</span>

<div class="viewcode-block" id="Volume.get_surface"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.get_surface">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bone&quot;</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cache_dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cached_</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">_mesh.vtp&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cache_path: </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_cached</span> <span class="ow">and</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading cached </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2"> mesh from </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;meshing </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2"> segmentation...&quot;</span><span class="p">)</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_surface</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;caching </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2"> surface to </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">surface</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">surface</span></div>

    <span class="n">_mesh_material</span> <span class="o">=</span> <span class="s2">&quot;bone&quot;</span>

<div class="viewcode-block" id="Volume.get_mesh_in_world"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.get_mesh_in_world">[docs]</a>    <span class="k">def</span> <span class="nf">get_mesh_in_world</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a pyvista mesh of the outline in world-space.</span>

<span class="sd">        Args:</span>
<span class="sd">            full (bool): Whether to render the full volume or just a wireframe. Defaults to False.</span>
<span class="sd">            cache_dir (Optional[Path], optional): a location to cache the bone surface.</span>
<span class="sd">            use_cached (bool): If False, don&#39;t use the cached bone surface but re-create it (expensive). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pv.PolyData: pyvista mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_ijk</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">mesh</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;getting full surface mesh for volume&quot;</span><span class="p">)</span>
            <span class="n">material_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span>
                <span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mesh_material</span><span class="p">,</span>
                <span class="n">use_cached</span><span class="o">=</span><span class="n">use_cached</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">material_mesh</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="p">))</span>
            <span class="n">mesh</span> <span class="o">+=</span> <span class="n">material_mesh</span>

        <span class="k">return</span> <span class="n">mesh</span></div>

<div class="viewcode-block" id="Volume.crop"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.crop">[docs]</a>    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_box</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Volume</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crop the volume to a given bounding box.</span>

<span class="sd">        Args:</span>
<span class="sd">            crop_box (Tuple[Tuple[float, float], ...]): The bounding box to crop to, in IJK.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Volume: The cropped volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crop_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_box</span><span class="p">)</span>
        <span class="n">crop_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">crop_box</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">crop_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">crop_box</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

        <span class="n">cropped_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="n">crop_box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">crop_box</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">crop_box</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="n">cropped_materials</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cropped_materials</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span>
                <span class="n">crop_box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">crop_box</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">crop_box</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">crop_box</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">]</span>

        <span class="n">cropped_anatomical_from_IJK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cropped_anatomical_from_IJK</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_from_ijk</span> <span class="o">@</span> <span class="n">geo</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="n">crop_box</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="n">cropped_data</span><span class="p">,</span>
            <span class="n">materials</span><span class="o">=</span><span class="n">cropped_materials</span><span class="p">,</span>
            <span class="n">anatomical_from_IJK</span><span class="o">=</span><span class="n">cropped_anatomical_from_IJK</span><span class="p">,</span>
            <span class="n">world_from_anatomical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world_from_anatomical</span><span class="p">,</span>
            <span class="n">anatomical_coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_coordinate_system</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Volume.get_bbox_IJK"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.get_bbox_IJK">[docs]</a>    <span class="k">def</span> <span class="nf">get_bbox_IJK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the bounding box of the materials in IJK.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The bounding box as a [3, 2] array.</span>
<span class="sd">            None, if the volume is empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">any_material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">any_material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">any_material</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">any_material</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">bbox</span></div>

<div class="viewcode-block" id="Volume.shrink"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.Volume.shrink">[docs]</a>    <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Volume</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crop the volume to remove empty space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Volume: The cropped volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bbox_IJK</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;shrink called on empty volume&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MetalVolume"><a class="viewcode-back" href="../../../deepdrr.vol.html#deepdrr.MetalVolume">[docs]</a><span class="k">class</span> <span class="nc">MetalVolume</span><span class="p">(</span><span class="n">Volume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as a volume, but with a different segmentation for the materials.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_hounsfield_to_density</span><span class="p">(</span><span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1"># TODO: verify</span>
        <span class="k">return</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">hu_values</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_segment_materials</span><span class="p">(</span>
        <span class="n">hu_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">use_thresholding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_thresholding</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">air</span><span class="o">=</span><span class="p">(</span><span class="n">hu_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">bone</span><span class="o">=</span><span class="p">(</span><span class="n">hu_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">titanium</span><span class="o">=</span><span class="p">(</span><span class="n">hu_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Benjamin D. Killeen, Cong Gao, Jan-Nico Zaech, and Mathias Unberath.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>